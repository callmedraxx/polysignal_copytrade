# Deposit Address Creation Flow

## What Happens When `/api/deposit/create-addresses` Receives a JWT Token

### Step-by-Step Flow

1. **JWT Token Received**
   ```
   POST /api/deposit/create-addresses
   Headers: Authorization: Bearer <JWT_TOKEN>
   Body: (empty - no parameters needed)
   ```

2. **Authentication Middleware (`authenticateToken`)**
   - Extracts JWT token from `Authorization: Bearer <token>` header
   - Verifies the token signature using `JWT_SECRET`
   - Decodes the token payload to get:
     ```json
     {
       "userId": "user-uuid",
       "address": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb"
     }
     ```
   - Attaches to request:
     - `req.userId` = user's database ID
     - `req.userAddress` = user's Ethereum address (from JWT)
   - If token is invalid/expired → Returns 401 Unauthorized

3. **Endpoint Handler**
   - Gets `userAddress` from `req.userAddress` (set by middleware)
   - Calls `createDepositAddresses(userAddress)`

4. **`createDepositAddresses` Function** (`src/services/bridge-deposit.ts`)
   
   **a. Lookup User in Database**
   ```typescript
   const user = await getUserByAddress(userAddress);
   ```
   - Queries database for user with matching address
   - If user not found → Throws error: "User not found"
   
   **b. Check Proxy Wallet**
   ```typescript
   if (!user.proxyWallet) {
     throw new Error("User does not have a proxy wallet. Please complete signup first.");
   }
   ```
   - Verifies user has a proxy wallet (Safe wallet on Polygon)
   - If no proxy wallet → Returns 404 error
   
   **c. Call Polymarket Bridge API**
   ```typescript
   const response = await fetch(`${BRIDGE_API_URL}/deposit`, {
     method: 'POST',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify({
       address: proxyWalletAddress, // User's Safe wallet address, NOT original address
     }),
   });
   ```
   - Calls Polymarket Bridge API: `https://bridge-api.polymarket.com/deposit`
   - Sends the **proxy wallet address** (Safe wallet), not the user's original address
   - This creates unique deposit addresses for bridging assets
   
   **d. Process Response**
   - Polymarket Bridge API returns deposit addresses for:
     - Ethereum (EVM chains)
     - Solana (SVM)
     - Bitcoin (BTC)
   - Each deposit address is unique and linked to the proxy wallet
   - All deposits to these addresses are automatically:
     - Bridged to Polygon
     - Swapped to USDC.e
     - Credited to the user's proxy wallet

5. **Return Response**
   ```json
   {
     "address": "0x56687bf447db6ffa42ffe2204a05edaa20f55839",
     "depositAddresses": [
       {
         "chainId": "1",
         "chainName": "Ethereum",
         "tokenAddress": "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",
         "tokenSymbol": "USDC",
         "depositAddress": "0x1234567890abcdef..."
       },
       // ... more addresses for other chains/tokens
     ],
     "note": "Optional note from Polymarket API"
   }
   ```

## Important Points

### ✅ What the Endpoint Does:
1. **Identifies User**: From JWT token → Gets user address → Looks up in database
2. **Gets Proxy Wallet**: Retrieves user's Safe wallet address from database
3. **Creates Deposit Addresses**: Calls Polymarket Bridge API with proxy wallet address
4. **Returns Addresses**: Returns all deposit addresses for different chains/tokens

### ✅ Why No Parameters Needed:
- User is identified from JWT token (automatic)
- Proxy wallet is stored in database (automatic lookup)
- Deposit addresses are generated by Polymarket Bridge API (automatic)

### ✅ Security:
- JWT token must be valid and not expired
- User must exist in database
- User must have completed signup (have proxy wallet)
- All addresses are linked to user's proxy wallet, not original wallet

### ✅ Use Cases:
- **First time**: User calls this to get deposit addresses for bridging
- **Subsequent calls**: User can call again to get fresh addresses (Polymarket may generate new ones)
- **Multiple chains**: Returns addresses for Ethereum, Solana, Bitcoin, etc.

## Example Frontend Usage

```typescript
// 1. User is authenticated (has JWT token)
const token = getStoredJWTToken();

// 2. Call endpoint with JWT in header
const response = await fetch('https://poly.dev.api.polysignal.io/api/deposit/create-addresses', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`, // JWT token here
  },
  // No body needed!
});

const data = await response.json();

// 3. Use the deposit addresses
console.log('Proxy wallet:', data.address);
console.log('Ethereum deposit address:', 
  data.depositAddresses.find(addr => addr.chainId === '1')?.depositAddress
);
```

## Error Responses

- **401 Unauthorized**: JWT token missing, invalid, or expired
- **404 Not Found**: User doesn't exist or doesn't have a proxy wallet
- **500 Internal Server Error**: Polymarket Bridge API error or other server error

